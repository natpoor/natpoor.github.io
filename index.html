<!DOCTYPE html>
 <html>
   <head>
    <title>Open Data Index Model Predictions</title>
    <meta charset="UTF-8">
   </head>

    <!-- <script type="text/javascript" src="d3/d3.js"></script> -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>


<style>
body
.tooltip {
  position: absolute;
  width: 150px;
  height: 40px;
  border: 1px;
  padding: 4px;
  border-radius: 8px;
  border-style: solid;
  border-color: black;
  background: AliceBlue;
  font-family: serif;
  font-size: 10pt;
  pointer-events: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

.legend {
    font-family: sans-serif;
    font-size: 11px;   // px, pt?
}

.title {
    font-family: sans-serif;
    font-size: 20px;
}
</style>

<body>
<div id="top-text">
 <h2>Modeling The Global Open Data Index (2014)</h2>
 Mouseover the dots for actual and model-predicted scores.
</div>

<div id="svg1-div"></div> <!-- This is the div for the scatterplot -->

<div id="bottom-text">
<b>Indexes used:</b><br />
<i>Dependent variable:</i><br />
The <a href="http://index.okfn.org/place/">Global Open Data Index</a>, 2014, from the Open Knowledge Foundation.<br />
<br />
<i>Independent variables:</i><br />
The <a href="https://en.wikipedia.org/wiki/Democracy_Index">Democracy Index</a>, 2012, via Wikpedia, from the Economist Intelligence Unit.<br />
The <a href="http://www.globalinnovationindex.org/">Global Innovation Index</a>, 2014.<br />
The <a href="https://en.wikipedia.org/wiki/Press_Freedom_Index">Press Freedom Index</a>, 2014, via Wikipedia, from Reporters Without Borders.<br />
<a href="http://data.worldbank.org/indicator/NY.GDP.MKTP.CD">Gross Domestic Product (GDP)</a>, 2014, from the World Bank.<br />
<br />
<i>The model:</i><br />
<pre>
                Estimate Std. Error t value Pr(>|t|)    
(Intercept)  -2.351e+00  1.748e+00  -1.345   0.1822    
dem_scoreC    7.108e+00  1.546e+00   4.597 1.52e-05 ***
demCsquared   6.927e-01  3.674e-01   1.885   0.0629 .  
gii_scoreC    3.970e-01  1.790e-01   2.218   0.0293 *  
press_scoreC  2.639e-01  1.590e-01   1.659   0.1008    
gdpC          1.004e-06  6.086e-07   1.649   0.1029    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 11.23 on 83 degrees of freedom
  (4 observations deleted due to missingness)
Multiple R-squared:  0.6268,	Adjusted R-squared:  0.6043 
F-statistic: 27.88 on 5 and 83 DF,  p-value: < 2.2e-16
</pre><br />
<i>What does this mean?</i><br />
The model, a regression run in R, shows that democracy is really important for open data! How important? Important enough that
there is an exponential relationship between the two. (I noticed this when I plotted just the democracy score against the
open data score, the scatterplot wasn't roughly linear, it curved up, thus, more is more.) So, more democracy generally means
even more open data in a non-linear relationship (so like 1=1, 2=4, 3=9, etc).
<br /><br />
<i>Variable scales:</i><br />
<ul>
 <li>Open data: 0-100 (percentage). Higher = more open data.</li>
 <li>Democracy index: 1.00 - 9.99 (essentially 1.00 - 10.00, two decimal places). Higher = more democracy.</li>
 <li>Global innovation: 0.00 - 100 (two decimal places). Higher = more innovation.</li>
 <li>Press freedom: 0.00 - 100 (two decimal places). Higher = <i>less free</i>.</li>
 <li>GDP: $US in millions. Higher = more GDP.</li>
</ul>
<br /><br />
<i>Model notes:</i><br />
There are three things to note: the exponential term for the democracy score, the inclusion of p-values just over 0.10, and
press freedom is influencing the model in the wrong direction!
<ol>
<li>The exponential term, that is, more democracy results in an even greater open data index score (exponentially not just linearly),
shows the importance of democracy to open data, <a href="http://www.rstreet.org/2014/05/22/democracy-and-open-data-are-the-two-linked/">as noted by Molly Schwartz in May 2014</a>,
although the analysis here is different. But it means that the variables are centered, that is, the average of each is subtracted 
from each observation (so the mean of the centered version of each variable becomes zero). The you can make the squared term.
I put a 'C' in the centered versions of the variables, as you can see in the model (I could have renamed everything for
presentation but it's easy enough to understand).</li>
<li>If you know statistics a little, you might recall that p-values are taught as a cutoff. Except, that's wrong.
P-values are a general guide that allow us to discerne variables of interest or, if we already know some varaibles that are theoretically
relevant, such as GDP, we can then tell if we should keep them in the model. So, a p-value of 0.1029 for GDP is fine. That tells
us that we are 89.71% sure that there is a statistical relationship between GDP and the dependent variable (Open Data score),
given the other variables, <i>all other things being equal</i>. But all other things aren't equal. We know GDP is theoretically
relevant (a country has to have enough wealth to have a government with a computer infrastructure where data is stored and 
from where that data can be shared). So, we keep it and the Press Freedom score (a indicator of information sharing), because
we know that a p-value just over 0.10 is fine for theoretically relevant variables. ("Just over" well how much is ok? I don't know.)</li>
<li>Why is press freedom working in the wrong direction? That is, higher scores of press freedom (less press freedom) means more
open data, although the influence is small. I don't know yet, I'm looking at that.</li>
</ol>
<br /><br />
Lastly, the adjusted R-squared, a measure of how much of the variance of the dependent variable is explained by the model,
is 0.6043, so about 60% of what is going on with the Open Data score is explained by the model, which is really good
(it's especially a good amount for the social sciences).<br />
</div>

<script type="text/javascript">
var h = 1000
var w = 1000

var padding = 25 // SCALES AND PADDING SOOOOO IMPORTANT!!!!

var xScale = d3.scale.linear()  
              .domain([0, 100]) // input domain
              .range([padding, w - padding]); // output range -- scale on Dem is 0-100 but my svg is 1000 wide, so svg Width = w

var yScale = d3.scale.linear()
              .domain([0, 100]) // input domain - this is from small to large
              .range([h - padding, padding]); // output range, svg Height = h -- REVERSED since it's comp sci co-ord setup but the output isn't!!!

var xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom");

var yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left");

var mysvg = d3.select("#svg1-div").append("svg")
    .attr("height", h)
    .attr("width", w);

// add the tooltip area to the webpage
var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
    // http://bl.ocks.org/weiglemc/6185069

// apparently only works with a WEB SERVER serving it (what!) or maybe via Firefox.
var mydata = []
// callback interior for reading CSV starts here! Get the data.
d3.csv("opendata2.csv", function(data) {
  mydata = data.map(function(d) {
  return {
    country : d.country,  // leaves as text
    predicted : +d.predicted, // coerces to number, the + there
    actual : +d.actual,  // coerces to number, the + there
    ypos : +d.ypos // coerce to numeric, this is the ypos to add jitter and hopefully reduce overlap
    };
    });

  mysvg.selectAll("text") // do words first, so circles are drawn over them and can mouseover better (text blocks this)
      .data(mydata)
      .enter().append("text")
        .attr("x", function(d) { return xScale(d.predicted) + 5} )
        .attr("y", function(d) { return yScale(d.ypos) + 3} )
        .text( function(d) { return d.country })
        .attr("font-family", "sans-serif")
        .attr("font-size", "11px")
        .attr("fill", "black");

  mysvg.selectAll("circle")
      .data(mydata)
      .enter().append("circle")
        .attr("cx", function(d) { return xScale(d.predicted)} )
        .attr("cy", function(d) { return yScale(d.ypos) } )
        .attr("r", 4)
        .style("fill", function(d) {
          if (d.actual - d.predicted > 10) {return "blue"}
          else if (d.actual - d.predicted < -10) {return "red"}
          else {return "black"}
         }) //style ones, } is function and the ) is for the style call
        .on("mouseover", function(d) {
          tooltip.transition()
               .duration(150)
               .style("opacity", 1);
          tooltip.html(d.country + "<br/> Actual: " + d.actual + "<br/> Model: " + Math.round(d.predicted))
               .style("left", (d3.event.pageX + 5) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
        }) // mouseover
        .on("mouseout", function(d) {
          tooltip.transition()
               .duration(300)
               .style("opacity", 0);
        }); // mouseout

  mysvg.append("g")   // these have to be in the callback, I hate the callback......
      .attr("class", "axis")  //Assign "axis" class  above in CSS styles
      .attr("transform", "translate(0," + (h - padding) + ")")
      .call(xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", w - 25)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("Model Prediction");

  mysvg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(" + padding + ",0)")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 15)
      .attr("x", -30)
      .style("text-anchor", "end")
      .text("Actual Open Data Index");

  var myline = mysvg.append("line")
     .attr("x1", xScale(0))
     .attr("y1", yScale(0))
     .attr("x2", xScale(100))
     .attr("y2", yScale(100))
     .attr("stroke-width", 1)
     .attr("stroke", "slategray")
     .style("stroke-dasharray", ("3, 5"));

// THIS NEXT CHUNK IS FOR THE LEGEND including the funny little dataset I am using, a hack really.
var colorData = [["blue", "Above Model Prediction"], ["black", "As Predicted, +/- 10"], ["red", "Below Model Prediction"]]
// trying to avoid having to declare this in the dataset
// so make it its own little dataset and generate the legend elements from it.
var legendRectSize = 10
var legendSpacing  = 5

var legend = mysvg.selectAll('.legend')
  .data(colorData)
  .enter()
  .append('g')
  .attr('class', 'legend')
  .attr('transform', function(d, i) {
    var height = legendRectSize + legendSpacing;
    var offset =  height * 3 / 2;    // 3 is the number of legend items, I think
    var horz = -2 * legendRectSize + (w * .8); // so, 80% of the way to the right of the overall Width w
    var vert = i * height - offset + (h * .6); 
    return 'translate(' + horz + ',' + vert + ')';
    });

legend.append('rect')
  .attr('width', legendRectSize)
  .attr('height', legendRectSize)
  .style('fill', function(d) { return d[0]; } ); // woo!
//  .style('stroke', color);

legend.append('text')
  .attr('x', legendRectSize + legendSpacing)
  .attr('y', legendRectSize - 2)
  .text(function(d) { return d[1]; });

var chartTitle = mysvg.append('g')
  .attr("transform", "translate(" + xScale(20) + "," + yScale(90) + ")")
  .attr("class", "title");

chartTitle.append('text')
  .text("Open Data Index");

chartTitle.append('text')
  .attr('y', 25)
  .attr('x', 10)
  .text("by Country");

chartTitle.append('text')
  .attr('y', 50)
  .attr('x', 10)
  .text("Model vs. Actual");

chartTitle.append('text')
  .attr('y', 75)
  .attr('x', 10)
  .text("(with jitter)");



});  // THIS IS THE CALLBACK INSIDE THESE for the main data biding
//have the drawing in the callback ??? so it draws AFTER the data is read. I don't get it yet. VICTORY!!!! OMG that sucked.
</script>

</body>
</html>
